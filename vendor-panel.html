<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Vendor Dashboard - Stayscape</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css"
            rel="stylesheet"
        />
        <style>
            :root {
                --sidebar-bg: #27ae60;
                --sidebar-hover: #2ecc71;
                --primary-color: #27ae60;
                --success-color: #2ecc71;
                --warning-color: #f39c12;
                --danger-color: #e74c3c;
                --info-color: #17a2b8;
                --light-bg: #f8f9fa;
                --card-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            body {
                background-color: var(--light-bg);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            .vendor-sidebar {
                background-color: var(--sidebar-bg);
                min-height: 100vh;
                position: fixed;
                top: 0;
                left: 0;
                width: 280px;
                z-index: 1000;
                transition: all 0.3s ease;
            }

            .vendor-content {
                margin-left: 280px;
                padding: 20px;
                min-height: 100vh;
            }

            .sidebar-brand {
                padding: 20px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                color: white;
            }

            .sidebar-nav {
                padding: 20px 0;
            }

            .nav-item {
                margin: 5px 15px;
            }

            .nav-link {
                color: rgba(255, 255, 255, 0.8);
                padding: 12px 20px;
                border-radius: 8px;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                text-decoration: none;
            }

            .nav-link:hover,
            .nav-link.active {
                background-color: var(--sidebar-hover);
                color: white;
            }

            .nav-link i {
                width: 20px;
                margin-right: 10px;
            }

            .stats-card {
                background: white;
                border-radius: 10px;
                padding: 25px;
                box-shadow: var(--card-shadow);
                border: none;
                height: 100%;
                margin-bottom: 20px;
            }

            .stats-icon {
                width: 60px;
                height: 60px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                color: white;
                margin-bottom: 15px;
            }

            .stats-number {
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 5px;
            }

            .stats-label {
                color: #6c757d;
                font-size: 0.9rem;
                margin-bottom: 10px;
            }

            .data-table {
                background: white;
                border-radius: 10px;
                overflow: hidden;
                box-shadow: var(--card-shadow);
                margin-bottom: 20px;
            }

            .table-header {
                background-color: var(--primary-color);
                color: white;
                padding: 20px;
                margin: 0;
                font-weight: 600;
            }

            .table th {
                border: none;
                background: #f8f9fa;
                font-weight: 600;
                color: #495057;
                padding: 15px;
            }

            .table td {
                border: none;
                padding: 15px;
                vertical-align: middle;
            }

            .table tbody tr {
                border-bottom: 1px solid #f1f3f4;
            }

            .table tbody tr:hover {
                background: #f8f9fa;
            }

            .status-badge {
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: 500;
            }

            .status-confirmed {
                background: #d4edda;
                color: #155724;
            }
            .status-pending {
                background: #fff3cd;
                color: #856404;
            }
            .status-cancelled {
                background: #f8d7da;
                color: #721c24;
            }
            .status-completed {
                background: #d1ecf1;
                color: #0c5460;
            }

            .chart-container {
                background: white;
                border-radius: 10px;
                padding: 25px;
                box-shadow: var(--card-shadow);
                height: 400px;
                margin-bottom: 20px;
            }

            .vendor-header {
                background: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: var(--card-shadow);
                margin-bottom: 25px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .user-info {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .user-avatar {
                width: 40px;
                height: 40px;
                background: var(--primary-color);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 600;
            }

            .content-section {
                display: none;
            }

            .content-section.active {
                display: block;
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: #6c757d;
            }

            .empty-state i {
                font-size: 4rem;
                margin-bottom: 20px;
                opacity: 0.5;
            }

            .btn-action {
                padding: 5px 10px;
                margin: 2px;
                border-radius: 5px;
                border: none;
                cursor: pointer;
                font-size: 12px;
            }

            .btn-view {
                background: var(--info-color);
                color: white;
            }
            .btn-edit {
                background: var(--warning-color);
                color: white;
            }
            .btn-delete {
                background: var(--danger-color);
                color: white;
            }
            .btn-approve {
                background: var(--success-color);
                color: white;
            }

            .property-form {
                background: white;
                border-radius: 10px;
                padding: 25px;
                box-shadow: var(--card-shadow);
                margin-bottom: 20px;
            }

            @media (max-width: 768px) {
                .vendor-sidebar {
                    transform: translateX(-100%);
                }

                .vendor-content {
                    margin-left: 0;
                }
            }
        </style>
    </head>
    <body>
        <!-- Sidebar -->
        <div class="vendor-sidebar" id="vendorSidebar">
            <div class="sidebar-brand">
                <h4 class="mb-0">
                    <i class="fas fa-store me-2"></i>
                    Vendor Panel
                </h4>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a
                        href="#"
                        class="nav-link active"
                        onclick="showSection('dashboard')"
                    >
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </div>
                <div class="nav-item">
                    <a
                        href="#"
                        class="nav-link"
                        onclick="showSection('properties')"
                    >
                        <i class="fas fa-building"></i>
                        My Properties
                    </a>
                </div>
                <div class="nav-item">
                    <a
                        href="#"
                        class="nav-link"
                        onclick="showSection('bookings')"
                    >
                        <i class="fas fa-calendar-check"></i>
                        Bookings
                    </a>
                </div>
                <div class="nav-item">
                    <a
                        href="#"
                        class="nav-link"
                        onclick="showSection('earnings')"
                    >
                        <i class="fas fa-chart-line"></i>
                        Earnings
                    </a>
                </div>
                <div class="nav-item">
                    <a
                        href="#"
                        class="nav-link"
                        onclick="showSection('add-property')"
                    >
                        <i class="fas fa-plus"></i>
                        Add Property
                    </a>
                </div>
                <div class="nav-item">
                    <a
                        href="#"
                        class="nav-link"
                        onclick="showSection('profile')"
                    >
                        <i class="fas fa-user"></i>
                        Profile
                    </a>
                </div>
                <div class="nav-item mt-4">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </a>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="vendor-content">
            <!-- Header -->
            <div class="vendor-header">
                <h2 class="mb-0" id="pageTitle">Dashboard</h2>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">V</div>
                    <div>
                        <div class="fw-bold" id="userName">Vendor User</div>
                        <small class="text-muted">Property Manager</small>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <!-- Stats Cards -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div
                                class="stats-icon"
                                style="background-color: var(--primary-color)"
                            >
                                <i class="fas fa-building"></i>
                            </div>
                            <div
                                class="stats-number text-success"
                                id="totalProperties"
                            >
                                0
                            </div>
                            <div class="stats-label">My Properties</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div
                                class="stats-icon"
                                style="background-color: var(--info-color)"
                            >
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div
                                class="stats-number text-info"
                                id="totalBookings"
                            >
                                0
                            </div>
                            <div class="stats-label">Total Bookings</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div
                                class="stats-icon"
                                style="background-color: var(--warning-color)"
                            >
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div
                                class="stats-number text-warning"
                                id="totalEarnings"
                            >
                                PKR 0
                            </div>
                            <div class="stats-label">Total Earnings</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div
                                class="stats-icon"
                                style="background-color: var(--danger-color)"
                            >
                                <i class="fas fa-star"></i>
                            </div>
                            <div
                                class="stats-number text-danger"
                                id="avgRating"
                            >
                                4.5
                            </div>
                            <div class="stats-label">Average Rating</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-8">
                        <div class="chart-container">
                            <h5 class="mb-3">Monthly Earnings</h5>
                            <canvas id="earningsChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="chart-container">
                            <h5 class="mb-3">Property Performance</h5>
                            <canvas id="propertyChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Bookings -->
                <div class="data-table">
                    <h5 class="table-header">Recent Bookings</h5>
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Booking ID</th>
                                    <th>Guest</th>
                                    <th>Property</th>
                                    <th>Check-in</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentBookingsTable">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Properties Section -->
            <div id="properties" class="content-section">
                <div class="data-table">
                    <h5 class="table-header">My Properties</h5>
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Property ID</th>
                                    <th>Title</th>
                                    <th>Location</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Bookings</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="propertiesTable">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bookings Section -->
            <div id="bookings" class="content-section">
                <div class="data-table">
                    <h5 class="table-header">Property Bookings</h5>
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Booking ID</th>
                                    <th>Guest Details</th>
                                    <th>Property</th>
                                    <th>Dates</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allBookingsTable">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Earnings Section -->
            <div id="earnings" class="content-section">
                <div class="row g-4 mb-4">
                    <div class="col-lg-8">
                        <div class="chart-container">
                            <h5 class="mb-3">Monthly Revenue Breakdown</h5>
                            <canvas id="monthlyRevenueChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="chart-container">
                            <h5 class="mb-3">Property Earnings</h5>
                            <canvas id="propertyEarningsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="data-table">
                    <h5 class="table-header">Earnings by Property</h5>
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Property</th>
                                    <th>Location</th>
                                    <th>Total Bookings</th>
                                    <th>Total Earnings</th>
                                    <th>Average per Booking</th>
                                </tr>
                            </thead>
                            <tbody id="earningsTable">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Add Property Section -->
            <div id="add-property" class="content-section">
                <div class="property-form">
                    <h5 class="mb-4">Add New Property</h5>
                    <form id="addPropertyForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Property Title</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="propertyTitle"
                                    required
                                />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Property Type</label>
                                <select
                                    class="form-select"
                                    id="propertyType"
                                    required
                                >
                                    <option value="">Select Type</option>
                                    <option value="apartment">Apartment</option>
                                    <option value="house">House</option>
                                    <option value="villa">Villa</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"
                                    >Price per Night (PKR)</label
                                >
                                <input
                                    type="number"
                                    class="form-control"
                                    id="propertyPrice"
                                    required
                                />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">City</label>
                                <select
                                    class="form-select"
                                    id="propertyCity"
                                    required
                                >
                                    <option value="">Select City</option>
                                    <option value="karachi">Karachi</option>
                                    <option value="lahore">Lahore</option>
                                    <option value="islamabad">Islamabad</option>
                                    <option value="rawalpindi">
                                        Rawalpindi
                                    </option>
                                    <option value="faisalabad">
                                        Faisalabad
                                    </option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Location</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="propertyLocation"
                                    required
                                />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Max Guests</label>
                                <input
                                    type="number"
                                    class="form-control"
                                    id="maxGuests"
                                    min="1"
                                    required
                                />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Bedrooms</label>
                                <input
                                    type="number"
                                    class="form-control"
                                    id="bedrooms"
                                    min="1"
                                    required
                                />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Bathrooms</label>
                                <input
                                    type="number"
                                    class="form-control"
                                    id="bathrooms"
                                    min="1"
                                    required
                                />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea
                                    class="form-control"
                                    id="propertyDescription"
                                    rows="4"
                                    required
                                ></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label"
                                    >Amenities (comma separated)</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="amenities"
                                    placeholder="WiFi, AC, Pool, Parking"
                                />
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus me-2"></i>Add Property
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profile" class="content-section">
                <div class="property-form">
                    <h5 class="mb-4">Vendor Profile</h5>
                    <form id="profileForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Full Name</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="vendorName"
                                />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Company Name</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="companyName"
                                />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input
                                    type="email"
                                    class="form-control"
                                    id="vendorEmail"
                                    readonly
                                />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input
                                    type="tel"
                                    class="form-control"
                                    id="vendorPhone"
                                />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">City</label>
                                <select class="form-select" id="vendorCity">
                                    <option value="">Select City</option>
                                    <option value="karachi">Karachi</option>
                                    <option value="lahore">Lahore</option>
                                    <option value="islamabad">Islamabad</option>
                                    <option value="rawalpindi">
                                        Rawalpindi
                                    </option>
                                    <option value="faisalabad">
                                        Faisalabad
                                    </option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Address</label>
                                <textarea
                                    class="form-control"
                                    id="vendorAddress"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-2"></i>Update
                                    Profile
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            let currentVendor = null;
            let charts = {};

            // Initialize vendor panel
            document.addEventListener('DOMContentLoaded', function () {
                checkVendorAuth();
                loadDashboardData();
            });

            function checkVendorAuth() {
                const vendorData = localStorage.getItem('vendorUser');
                if (!vendorData) {
                    window.location.href = 'vendor-login.html';
                    return;
                }

                currentVendor = JSON.parse(vendorData);
                document.getElementById('userName').textContent =
                    currentVendor.name;
                document.getElementById('userAvatar').textContent =
                    currentVendor.name.charAt(0);

                // Populate profile form
                if (document.getElementById('vendorName')) {
                    document.getElementById('vendorName').value =
                        currentVendor.name || '';
                    document.getElementById('companyName').value =
                        currentVendor.company_name || '';
                    document.getElementById('vendorEmail').value =
                        currentVendor.email || '';
                    document.getElementById('vendorPhone').value =
                        currentVendor.phone || '';
                    document.getElementById('vendorCity').value =
                        currentVendor.city || '';
                }
            }

            async function loadDashboardData() {
                try {
                    // Load vendor dashboard data
                    const response = await fetch('vendor-api.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'get_vendor_dashboard',
                            vendor_id: currentVendor.vendor_id,
                        }),
                    });

                    const result = await response.json();
                    if (result.success) {
                        updateDashboardStats(result.data);
                        updateRecentBookingsTable(result.data.recent_bookings);
                    }
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    showErrorMessage('Failed to load dashboard data');
                }
            }

            function updateDashboardStats(data) {
                document.getElementById('totalProperties').textContent =
                    data.total_properties || 0;
                document.getElementById('totalBookings').textContent =
                    data.total_bookings || 0;
                document.getElementById('totalEarnings').textContent =
                    'PKR ' +
                    (data.total_earnings
                        ? parseInt(data.total_earnings).toLocaleString()
                        : '0');
            }

            function updateRecentBookingsTable(bookings) {
                const tbody = document.getElementById('recentBookingsTable');

                if (!bookings || bookings.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-calendar-times"></i>
                                <h6>No bookings found</h6>
                                <p>No recent bookings to display</p>
                            </div>
                        </td>
                    </tr>
                `;
                    return;
                }

                tbody.innerHTML = bookings
                    .map(
                        booking => `
                <tr>
                    <td><strong>${booking.booking_id}</strong></td>
                    <td>
                        <div><strong>${booking.guest_name}</strong></div>
                        <small class="text-muted">${booking.guest_email}</small>
                    </td>
                    <td>
                        <div>${booking.property_title}</div>
                        <small class="text-muted">${
                            booking.property_location
                        }</small>
                    </td>
                    <td>${new Date(
                        booking.checkin_date
                    ).toLocaleDateString()}</td>
                    <td><strong>PKR ${parseInt(
                        booking.total_amount
                    ).toLocaleString()}</strong></td>
                    <td><span class="status-badge status-${
                        booking.booking_status
                    }">${
                            booking.booking_status.charAt(0).toUpperCase() +
                            booking.booking_status.slice(1)
                        }</span></td>
                </tr>
            `
                    )
                    .join('');
            }

            async function loadProperties() {
                try {
                    const response = await fetch('vendor-api.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'get_vendor_properties',
                            vendor_id: currentVendor.vendor_id,
                            page: 1,
                            limit: 100,
                        }),
                    });

                    const result = await response.json();
                    if (result.success) {
                        updatePropertiesTable(result.data.properties);
                    }
                } catch (error) {
                    console.error('Error loading properties:', error);
                    showErrorMessage('Failed to load properties');
                }
            }

            function updatePropertiesTable(properties) {
                const tbody = document.getElementById('propertiesTable');

                if (!properties || properties.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-building"></i>
                                <h6>No properties found</h6>
                                <p>You haven't added any properties yet</p>
                            </div>
                        </td>
                    </tr>
                `;
                    return;
                }

                tbody.innerHTML = properties
                    .map(
                        property => `
                <tr>
                    <td><strong>${
                        property.property_id || property.id
                    }</strong></td>
                    <td>${property.title}</td>
                    <td>${property.location}</td>
                    <td><span class="badge bg-info">${property.type}</span></td>
                    <td><strong>PKR ${parseInt(
                        property.price
                    ).toLocaleString()}</strong></td>
                    <td><span class="badge bg-primary">${
                        property.total_bookings || 0
                    }</span></td>
                    <td><span class="status-badge ${
                        property.is_active
                            ? 'status-confirmed'
                            : 'status-cancelled'
                    }">${property.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn-action btn-view" onclick="viewProperty(${
                            property.id
                        })">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-action btn-edit" onclick="editProperty(${
                            property.id
                        })">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteProperty(${
                            property.id
                        })">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `
                    )
                    .join('');
            }

            async function loadBookings() {
                try {
                    const response = await fetch('vendor-api.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'get_property_bookings',
                            vendor_id: currentVendor.vendor_id,
                        }),
                    });

                    const result = await response.json();
                    if (result.success) {
                        updateAllBookingsTable(result.data.bookings);
                    }
                } catch (error) {
                    console.error('Error loading bookings:', error);
                    showErrorMessage('Failed to load bookings');
                }
            }

            function updateAllBookingsTable(bookings) {
                const tbody = document.getElementById('allBookingsTable');

                if (!bookings || bookings.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-calendar-times"></i>
                                <h6>No bookings found</h6>
                                <p>No bookings for your properties yet</p>
                            </div>
                        </td>
                    </tr>
                `;
                    return;
                }

                tbody.innerHTML = bookings
                    .map(
                        booking => `
                <tr>
                    <td><strong>${booking.booking_id}</strong></td>
                    <td>
                        <div><strong>${booking.guest_name}</strong></div>
                        <div><small>${booking.guest_email}</small></div>
                        <div><small>${booking.guest_phone}</small></div>
                    </td>
                    <td>
                        <div>${booking.property_title}</div>
                        <small class="text-muted">${
                            booking.property_location
                        }</small>
                    </td>
                    <td>
                        <div><strong>In:</strong> ${new Date(
                            booking.checkin_date
                        ).toLocaleDateString()}</div>
                        <div><strong>Out:</strong> ${new Date(
                            booking.checkout_date
                        ).toLocaleDateString()}</div>
                        <div><small>${booking.guests} guests</small></div>
                    </td>
                    <td><strong>PKR ${parseInt(
                        booking.total_amount
                    ).toLocaleString()}</strong></td>
                    <td><span class="status-badge status-${
                        booking.booking_status
                    }">${
                            booking.booking_status.charAt(0).toUpperCase() +
                            booking.booking_status.slice(1)
                        }</span></td>
                    <td>
                        <button class="btn-action btn-view" onclick="viewBooking('${
                            booking.booking_id
                        }')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `
                    )
                    .join('');
            }

            async function loadEarnings() {
                try {
                    const response = await fetch('vendor-api.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'get_vendor_earnings',
                            vendor_id: currentVendor.vendor_id,
                        }),
                    });

                    const result = await response.json();
                    if (result.success) {
                        updateEarningsCharts(result.data);
                        updateEarningsTable(result.data.property_earnings);
                    }
                } catch (error) {
                    console.error('Error loading earnings:', error);
                    showErrorMessage('Failed to load earnings data');
                }
            }

            function updateEarningsCharts(data) {
                // Monthly revenue chart
                const revenueCtx = document.getElementById(
                    'monthlyRevenueChart'
                );
                if (revenueCtx) {
                    if (charts.monthlyRevenue) charts.monthlyRevenue.destroy();

                    const monthlyRevenue = new Array(12).fill(0);
                    if (data.monthly_earnings) {
                        data.monthly_earnings.forEach(item => {
                            monthlyRevenue[item.month - 1] = item.total;
                        });
                    }

                    charts.monthlyRevenue = new Chart(revenueCtx, {
                        type: 'bar',
                        data: {
                            labels: [
                                'Jan',
                                'Feb',
                                'Mar',
                                'Apr',
                                'May',
                                'Jun',
                                'Jul',
                                'Aug',
                                'Sep',
                                'Oct',
                                'Nov',
                                'Dec',
                            ],
                            datasets: [
                                {
                                    label: 'Revenue (PKR)',
                                    data: monthlyRevenue,
                                    backgroundColor: '#27ae60',
                                    borderColor: '#2ecc71',
                                    borderWidth: 1,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true },
                            },
                        },
                    });
                }

                // Property earnings chart
                const propertyCtx = document.getElementById(
                    'propertyEarningsChart'
                );
                if (propertyCtx && data.property_earnings) {
                    if (charts.propertyEarnings)
                        charts.propertyEarnings.destroy();

                    charts.propertyEarnings = new Chart(propertyCtx, {
                        type: 'pie',
                        data: {
                            labels: data.property_earnings.map(
                                item => item.title
                            ),
                            datasets: [
                                {
                                    data: data.property_earnings.map(
                                        item => item.total_earnings || 0
                                    ),
                                    backgroundColor: [
                                        '#27ae60',
                                        '#3498db',
                                        '#f39c12',
                                        '#e74c3c',
                                        '#9b59b6',
                                    ],
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom' } },
                        },
                    });
                }
            }

            function updateEarningsTable(earnings) {
                const tbody = document.getElementById('earningsTable');

                if (!earnings || earnings.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-chart-line"></i>
                                <h6>No earnings data</h6>
                                <p>No earnings data available yet</p>
                            </div>
                        </td>
                    </tr>
                `;
                    return;
                }

                tbody.innerHTML = earnings
                    .map(
                        earning => `
                <tr>
                    <td><strong>${earning.title}</strong></td>
                    <td>${earning.location}</td>
                    <td><span class="badge bg-primary">${
                        earning.total_bookings || 0
                    }</span></td>
                    <td><strong>PKR ${parseInt(
                        earning.total_earnings || 0
                    ).toLocaleString()}</strong></td>
                    <td><strong>PKR ${
                        earning.total_bookings > 0
                            ? parseInt(
                                  (earning.total_earnings || 0) /
                                      earning.total_bookings
                              ).toLocaleString()
                            : '0'
                    }</strong></td>
                </tr>
            `
                    )
                    .join('');
            }

            // Add Property Form Handler
            document.addEventListener('DOMContentLoaded', function () {
                // Check auth first
                setTimeout(checkVendorAuth, 100);

                const addPropertyForm =
                    document.getElementById('addPropertyForm');
                if (addPropertyForm) {
                    addPropertyForm.addEventListener(
                        'submit',
                        async function (e) {
                            e.preventDefault();

                            const formData = {
                                action: 'add_property',
                                vendor_id: currentVendor.vendor_id,
                                title: document.getElementById('propertyTitle')
                                    .value,
                                type: document.getElementById('propertyType')
                                    .value,
                                price: document.getElementById('propertyPrice')
                                    .value,
                                city: document.getElementById('propertyCity')
                                    .value,
                                location:
                                    document.getElementById('propertyLocation')
                                        .value,
                                max_guests:
                                    document.getElementById('maxGuests').value,
                                bedrooms:
                                    document.getElementById('bedrooms').value,
                                bathrooms:
                                    document.getElementById('bathrooms').value,
                                description: document.getElementById(
                                    'propertyDescription'
                                ).value,
                                amenities: document
                                    .getElementById('amenities')
                                    .value.split(',')
                                    .map(a => a.trim())
                                    .filter(a => a),
                                pictures: [], // You can add image upload functionality here
                            };

                            try {
                                const response = await fetch('vendor-api.php', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify(formData),
                                });

                                const result = await response.json();
                                if (result.success) {
                                    alert('Property added successfully!');
                                    addPropertyForm.reset();
                                    showSection('properties');
                                } else {
                                    alert(
                                        'Failed to add property: ' +
                                            result.message
                                    );
                                }
                            } catch (error) {
                                alert('Error adding property');
                            }
                        }
                    );
                }

                // Profile form handler
                const profileForm = document.getElementById('profileForm');
                if (profileForm) {
                    profileForm.addEventListener('submit', async function (e) {
                        e.preventDefault();

                        const formData = {
                            action: 'update_vendor_profile',
                            vendor_id: currentVendor.vendor_id,
                            name: document.getElementById('vendorName').value,
                            phone: document.getElementById('vendorPhone').value,
                            company_name:
                                document.getElementById('companyName').value,
                            address:
                                document.getElementById('vendorAddress').value,
                            city: document.getElementById('vendorCity').value,
                        };

                        try {
                            const response = await fetch('vendor-api.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(formData),
                            });

                            const result = await response.json();
                            if (result.success) {
                                alert('Profile updated successfully!');
                                // Update current vendor data
                                currentVendor.name = formData.name;
                                currentVendor.phone = formData.phone;
                                currentVendor.company_name =
                                    formData.company_name;
                                currentVendor.city = formData.city;
                                localStorage.setItem(
                                    'vendorUser',
                                    JSON.stringify(currentVendor)
                                );
                                document.getElementById(
                                    'userName'
                                ).textContent = currentVendor.name;
                            } else {
                                alert(
                                    'Failed to update profile: ' +
                                        result.message
                                );
                            }
                        } catch (error) {
                            alert('Error updating profile');
                        }
                    });
                }
            });

            function showSection(sectionName) {
                // Hide all sections
                document
                    .querySelectorAll('.content-section')
                    .forEach(section => {
                        section.classList.remove('active');
                    });

                // Remove active class from all nav links
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });

                // Show selected section
                document.getElementById(sectionName).classList.add('active');

                // Add active class to clicked nav link
                event.target.classList.add('active');

                // Update page title
                const titles = {
                    dashboard: 'Dashboard',
                    properties: 'My Properties',
                    bookings: 'Property Bookings',
                    earnings: 'Earnings & Analytics',
                    'add-property': 'Add New Property',
                    profile: 'Vendor Profile',
                };

                document.getElementById('pageTitle').textContent =
                    titles[sectionName] || 'Dashboard';

                // Load section-specific data
                switch (sectionName) {
                    case 'properties':
                        loadProperties();
                        break;
                    case 'bookings':
                        loadBookings();
                        break;
                    case 'earnings':
                        loadEarnings();
                        break;
                }
            }

            function showErrorMessage(message) {
                console.error(message);
                // You can implement a toast notification here
            }

            function logout() {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('vendorUser');
                    window.location.href = 'vendor-login.html';
                }
            }

            // Placeholder functions for actions
            function viewProperty(propertyId) {
                alert('View property: ' + propertyId);
            }
            function editProperty(propertyId) {
                alert('Edit property: ' + propertyId);
            }
            function deleteProperty(propertyId) {
                if (confirm('Are you sure you want to delete this property?')) {
                    alert('Delete property: ' + propertyId);
                }
            }
            function viewBooking(bookingId) {
                alert('View booking: ' + bookingId);
            }
        </script>
    </body>
</html>
